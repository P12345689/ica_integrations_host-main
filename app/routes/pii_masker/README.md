# PII Masker Integration

This integration provides advanced services for processing Personally Identifiable Information (PII) in text. It offers capabilities to mask, delete, encrypt, decrypt, or replace PII with fake data, supporting a wide range of PII types and custom patterns.

It supports symmetric encryption and authentication using Fernet.

## Features

- Multiple PII processing options: mask, delete, encrypt, decrypt, or fake
- Support for numerous PII types out of the box
- Custom regex support for user-defined PII patterns
- Both system-level and experience-level API endpoints
- Utilizes FastAPI for high-performance API handling
- Implements robust error handling and logging
- Supports concurrent processing for improved performance
- Allows custom encryption/decryption keys

## Endpoints

1. System API: POST /system/pii_masker/retrievers/process_pii/invoke
   - Processes PII in the provided text without LLM involvement

2. Experience API: POST /experience/pii_masker/ask_process_pii/invoke
   - Processes PII and provides additional context using an LLM

## Supported PII Types

- Credit Card Numbers
- Names
- Email Addresses
- Phone Numbers
- Social Security Numbers (SSN)
- IP Addresses
- Dates of Birth
- Addresses
- Passport Numbers
- Driver's License Numbers
- Bank Account Numbers
- Custom (user-defined patterns)

## Processing Options

1. DELETE: Removes the PII from the text entirely
2. MASK: Replaces the PII with a descriptive placeholder (e.g., <CREDIT_CARD>)
3. ENCRYPT: Encrypts the PII using Fernet symmetric encryption
4. DECRYPT: Decrypts previously encrypted PII using the provided key
5. FAKE: Replaces the PII with realistic fake data generated by the Faker library

## Custom Regex Support

Extend PII detection capabilities by providing custom regex patterns. Add them to the `custom_regex` field in your request:

```json
"custom_regex": {
  "employee_id": "\\bEMP\\d{6}\\b",
  "project_code": "\\bPRJ-[A-Z]{3}\\d{3}\\b"
}
```

## Usage Examples

### Generate Encryption Key

The integration now includes an endpoint to generate valid Fernet encryption keys. You can use this endpoint to generate keys for use with the encrypt and decrypt operations.

To generate a new encryption key, use the following endpoint:

```bash
curl --location --request GET \
    'http://localhost:8080/system/pii_masker/generate_key/invoke' \
    --header 'Integrations-API-Key: dev-only-token'
```

This will return a valid Fernet encryption key that you can use in your requests.

If no custom key is provided, the integration will use a default key (which can be set using the PII_ENCRYPTION_KEY environment variable server-side).


### System API Example (Delete PII)

This example demonstrates how to delete PII from the text:

```bash
curl --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "My credit card is 1234-5678-9012-3456, my SSN is 123-45-6789, and my email is john.doe@example.com.",
        "mask_type": "delete",
        "pii_types": ["credit_card", "ssn", "email"]
    }'
```

Expected output:
```
My credit card is , my SSN is , and my email is .
```

### System API Example (Mask PII)

This example shows how to mask PII in the text:

```bash
curl --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "My name is John Doe, born on 1990-05-15. I live at 123 Main St, Anytown, TX 12345.",
        "mask_type": "mask",
        "pii_types": ["name", "date_of_birth", "address"]
    }'
```

Expected output:
```
My name is <NAME>, born on <DATE_OF_BIRTH>. I live at <ADDRESS>.
```

### System API Example (Encrypt PII with Custom Key)

This example demonstrates encrypting PII using a custom encryption key:

```bash
curl --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "My credit card is 1234-5678-9012-3456, my SSN is 123-45-6789.",
        "mask_type": "encrypt",
        "pii_types": ["credit_card", "ssn"],
        "encryption_key": "your_custom_encryption_key_here"
    }'
```

Expected output:
```
My credit card is gAAAAA..., my SSN is gAAAAA....
```

### System API Example (Decrypt PII)

This example shows how to decrypt previously encrypted PII:

```bash
curl --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "My credit card is gAAAAA..., my SSN is gAAAAA....",
        "mask_type": "decrypt",
        "pii_types": ["credit_card", "ssn"],
        "encryption_key": "your_custom_encryption_key_here"
    }'
```

Expected output:
```
My credit card is 1234-5678-9012-3456, my SSN is 123-45-6789.
```

### System API Example (Fake PII)

This example demonstrates replacing PII with fake data:

```bash
curl --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "My name is John Doe, my phone is (123) 456-7890, and my email is john.doe@example.com.",
        "mask_type": "fake",
        "pii_types": ["name", "phone", "email"]
    }'
```

Expected output:
```
My name is Jane Smith, my phone is (555) 123-4567, and my email is janesmith@fakeemail.com.
```

### System API Example (Custom Regex)

This example shows how to use custom regex patterns to detect and process additional PII types:

```bash
curl --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "My employee ID is EMP123456 and my project code is PRJ-ABC123.",
        "mask_type": "mask",
        "pii_types": ["custom"],
        "custom_regex": {
            "employee_id": "\\bEMP\\d{6}\\b",
            "project_code": "\\bPRJ-[A-Z]{3}\\d{3}\\b"
        }
    }'
```

Expected output:
```
My employee ID is <CUSTOM> and my project code is <CUSTOM>.
```

### Experience API Example

This example demonstrates using the Experience API to process PII and get additional context:

```bash
curl --location --request POST \
'http://localhost:8080/experience/pii_masker/ask_process_pii/invoke' \
--header 'Content-Type: application/json' \
--header 'Integrations-API-Key: dev-only-token' \
--data '{
    "text": "Please process this text: My passport number is AB1234567 and my driver'"'"'s license is XY987654.",
    "mask_type": "mask",
    "pii_types": ["passport", "drivers_license"]
}'
```

Expected output:
```
[LLM response explaining the processing]

Processed text:
Please process this text: My passport number is <PASSPORT> and my driver's license is <DRIVERS_LICENSE>.
```

These examples cover all the mask types (delete, mask, encrypt, decrypt, and fake) as well as demonstrate the use of custom regex patterns and the Experience API. They should provide users with a comprehensive understanding of how to use the PII Masker integration for various scenarios.


## Configuration

The integration uses the following environment variables:

- `ASSISTANTS_DEFAULT_MODEL_ID_OR_NAME`: The default LLM model to use (default: "Llama3.1 70b Instruct")
- `DEFAULT_MAX_THREADS`: Maximum number of threads for concurrent processing (default: 4)
- `PII_ENCRYPTION_KEY`: Default key used for PII encryption (auto-generated if not provided)

## Error Handling

The integration implements comprehensive error handling:

- Input validation errors return a 422 status code with details
- Processing errors return a 500 status code with a general error message
- All errors are logged for debugging purposes

## Extending the Integration

To add support for new PII types:

1. Update the `PIIType` enum in `pii_masker_router.py`
2. Add a new regex pattern to the `get_pii_patterns()` function
3. If using the FAKE option, add a new case in the `replace_with_fake()` function to generate appropriate fake data

## Security Considerations

- Ensure that encryption keys are securely managed and not exposed
- Implement proper access controls for the API endpoints
- Regularly update dependencies to address potential vulnerabilities
- Be cautious when handling decrypted data to prevent unintended exposure

## Encryption and Decryption

- The integration uses Fernet symmetric encryption for the ENCRYPT and DECRYPT operations
- You can provide a custom encryption key in the request. If not provided, a default key will be used
- To decrypt data, you must use the same key that was used for encryption
- Encrypted data is prefixed with 'gAAAAA' and can be easily identified in the processed text

## Testing

Comprehensive unit tests are provided in the `tests` directory. Run them using:

```
pytest tests/
```

## Dependencies

- FastAPI
- Pydantic
- Jinja2
- cryptography
- Faker

Ensure all dependencies are installed:

```
pip install fastapi pydantic jinja2 cryptography faker
```

## Rountrip example


```bash
curl -s --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "I want you to know all my data! My credit card is 374245455400126, my name is Mihai Criveti, my SSN is 635-40-3487, please call me at phone number 202-555-0109, email:potus@whitehouse.gov, and my personal one is boss@gmail.com, also, I have a company secret key mysecret.uuid.secret.primescotch.com and my IBMid 123988347",
        "mask_type": "encrypt",
        "encryption_key": "IFcBsIUURnIxCweQ7RItuMmG5DSc_sbTHD71bZ5xBQA="
    }' | jq
```

```bash
curl -s --location --request POST \
    'http://localhost:8080/system/pii_masker/retrievers/process_pii/invoke' \
    --header 'Content-Type: application/json' \
    --header 'Integrations-API-Key: dev-only-token' \
    --data '{
        "text": "I want you to know all my data! My credit card is gAAAAABmjChPdc2Ov7De9RJF8m23Wv7JSH94d5q201zoruVxWlRV-VvZR8FGsry8Ni05Ucd5tiYNhgJqbmVAYOIA0CR4W_O8mA==, my name is gAAAAABmjChPg69P7WUBSMJPiapgcSKJqtP9V0HfkmrMiXbEQ6p85i-kP0NRmTTPvsmlOYXFZmeC7SogrsvI3NyvPURjK5Qbzw==, my SSN is gAAAAABmjChP-NgnbpviKf3mlkITCBnvbFf-CvfuNPpjG1K9WuB4qYmFwCbTfUI9J36f3tOWpZg6hSdZTMBiA73vVMilYnUGQw==, please call me at phone number gAAAAABmjChPlHH3RN88kYq6w1vmDZcKnzk3qlPwVToh2xKQxvATrd2yeL4Lh2SKGb1-KXAh4MV4Dya8h2ICxsSXVQx90X9hLQ==, email:gAAAAABmjChPlV61FeO3VJyCz_PumTdxII-ddgMlLOQS1q9LFw0BkVMlbvdzszmzA_V0G58pPcR8oPTcY0Rt3LoLlTRjnQBK-tCdbDuJmYfFaB6XJmdsRHI=, and my personal one is gAAAAABmjChPSLm-mEisrHkZ7BTtuIgIquOr_qvg6-qr1HL_WY-eo9IrzQtJoCEZF3LwiQB_1a36H2BKhk0wVlXgIHkVrGQQ1Q==, also, I have a company secret key mysecret.uuid.secret.primescotch.com and my IBMid gAAAAABmjChPkz5M60VnmrtcnrLq-09uS8_-9iLUuldATXLuYAVco8fs_yJFBwgOQtOKNakD5_bwOvaAN0K32S8y3GDIetPIwg==",
        "mask_type": "decrypt",
        "encryption_key": "IFcBsIUURnIxCweQ7RItuMmG5DSc_sbTHD71bZ5xBQA="
    }' | jq
```


```json
{
  "status": "success",
  "invocationId": "73b07e3d-c7b9-467c-a819-c3344aa456de",
  "response": [
    {
      "message": "I want you to know all my data! My credit card is 374245455400126, my name is Mihai Criveti, my SSN is 635-40-3487, please call me at phone number 202-555-0109, email:potus@whitehouse.gov, and my personal one is boss@gmail.com, also, I have a company secret key mysecret.uuid.secret.primescotch.com and my IBMid 123988347",
      "type": "text"
    }
  ]
}
```

## Future

- AES256-GCM
